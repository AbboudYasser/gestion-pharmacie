# Ù…Ù„Ù GitHub Actions Ù„Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub Pages
# (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø·)

name: ğŸš€ Deploy to GitHub Pages

# Ù…ØªÙ‰ ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù€ workflow
on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
permissions:
  contents: read
  pages: write
  id-token: write

# Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ø¹Ø¯Ø© deployments ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
concurrency:
  group: "pages"
  cancel-in-progress: false

# Ø§Ù„Ù…Ù‡Ø§Ù… (Jobs) Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§
jobs:
  # Ù…Ù‡Ù…Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
  build:
    name: ğŸ”¨ Build Project
    runs-on: ubuntu-latest
    
    steps:
    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† repository
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Node.js (Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø«Ù„ npm)
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # ØªØ«Ø¨ÙŠØª dependencies Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    - name: ğŸ“¦ Install Dependencies
      run: |
        # ØªØ«Ø¨ÙŠØª npm packages Ø¥Ø°Ø§ ÙˆØ¬Ø¯ package.json
        if [ -f package.json ]; then
          npm ci
        fi
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
    - name: ğŸ—ï¸ Build Project
      run: |
        echo "ğŸ”§ Building project for GitHub Pages..."
        mkdir -p build
        cp -r frontend/* build/
        cp README.md build/ 2>/dev/null || echo "No README.md found"
        touch build/.nojekyll
        cat > build/robots.txt << EOF
        User-agent: *
        Allow: /
        Sitemap: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/sitemap.xml
        EOF
        cat > build/sitemap.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
          <url>
            <loc>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/</loc>
            <lastmod>$(date -u +%Y-%m-%d  )</lastmod>
          </url>
          <url>
            <loc>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/login.html</loc>
            <lastmod>$(date -u +%Y-%m-%d  )</lastmod>
          </url>
        </urlset>
        EOF
        echo "âœ… Build completed successfully!"
    
    # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙˆÙŠÙ† Ù„Ù„Ø¥Ù†ØªØ§Ø¬
    - name: âš™ï¸ Configure for Production
      run: |
        echo "ğŸ”§ Configuring for production environment..."
        if [ -f build/js/config.js ]; then
          sed -i 's|http://localhost:5000/api|https://qjh9iecend13.manus.space/api|g' build/js/config.js
          sed -i 's|MOCK_DATA: false|MOCK_DATA: true|g' build/js/config.js
          echo "âœ… Production configuration applied!"
        fi
        if [ -f build/index.html ]; then
          sed -i 's|href="frontend/css/|href="css/|g' build/index.html
          sed -i 's|src="frontend/js/|src="js/|g' build/index.html
          sed -i 's|href="frontend/|href="./|g' build/index.html
          sed -i 's|src="frontend/|src="./|g' build/index.html
          echo "âœ… Links updated for GitHub Pages!"
        fi
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
    - name: âœ… Validate Build
      run: |
        echo "ğŸ” Validating build..."
        required_files=(
          "build/index.html"
          "build/login.html"
          "build/js/config.js"
          "build/js/api.js"
          "build/css/style.css"
         )
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        echo "ğŸ“Š Build size:"
        du -sh build/
        echo "âœ… Build validation completed!"
    
    # Ø±ÙØ¹ artifacts Ù„Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: build/

  # Ù…Ù‡Ù…Ø© Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ“‹ Display Deployment Info
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"

  # Ù…Ù‡Ù…Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
  post-deploy-test:
    name: ğŸ§ª Post-Deploy Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Test Deployed Site
      run: |
        echo "ğŸ§ª Testing deployed site..."
        sleep 30
        SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "Testing home page..."
        if curl -f -s "$SITE_URL" > /dev/null; then
          echo "âœ… Home page is accessible"
        else
          echo "âŒ Home page is not accessible"
          exit 1
        fi
        echo "Testing login page..."
        if curl -f -s "$SITE_URL/login.html" > /dev/null; then
          echo "âœ… Login page is accessible"
        else
          echo "âŒ Login page is not accessible"
          exit 1
        fi
        echo "ğŸ‰ All tests passed!"

  # Ù…Ù‡Ù…Ø© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© )
  notify:
    name: ğŸ“¢ Notify Success
    needs: [deploy, post-deploy-test]
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ‰ Success Notification
      run: |
        echo "ğŸŠ Deployment Pipeline Completed Successfully!"
        echo "   â€¢ Site URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
